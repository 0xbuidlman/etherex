<html>
<head>
<title>EtherEx</title>
<style>
  body {
    background: url(sites/etherex.org/files/welcomia_0.jpg) no-repeat center top;
    background-size: cover;
    color: #fff;
    font-family: Futura, "Trebuchet MS", Arial, sans-serif;
    padding: 1em;
    text-align: center;
  }
  h1, h2 {
    font-family: Futura, "Trebuchet MS", Arial, sans-serif;
  }
  h1 { 
  	font-size: 2em;
  }
  ul {
    list-style-type: none;
  }
  li {

  }
  img {
    display: block;
    margin-left: auto;
    margin-right: auto;
  	margin: 1em;
  	padding: 0;
  }
  label {
    display: inline-block;
    float: left;
    padding-top: .75em;
    margin-right: 5%;
    text-align: right;
    width: 20%;
  }
  input {
    border: 0;
    float: left;
    margin-right: 25%;
    padding: .5em .5em .4em;
    width: 50%;
  }
  button {
    background: #333;
    border: 0;
    box-shadow: 1px 1px 5px #000;
    color: #fff;
    padding: .5em 1em;
  }
  table {
    background: rgba(0,0,0,0.25);
    border: 0;
    border-radius: 10px;
    margin: 1em;
    width: 100%;
  }
  tr:first-child {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }
  tr:last-child {
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
  }
  tr:nth-child(odd) {
    background: rgba(0,0,0,0.25);
  }
  td, th {
    padding: .5em 1em;
  }
  .book {
    width: 50%;
  }
</style>
<script>
  var etherExAddr = "0x995db8d9f8f4dcc2b35da87a3768bd10eb8ee2da";
  var tradesAddr = "0x6b385354b319a439b36bbeb74f8b8c0517b359ad";
  var xethAddr = "0x5d07190100b7e73def243e52eb9e575b939e20ef";
  var gavAddr = "0x929b11b8eeea00966e873a241d4b67f7540d1f38";
  sendGav = function() {
    // var data = "0x" + document.getElementById("to").value).pad(32);
    // data += bin(document.getElementById("value").value).pad(32);
    eth.transact(
      eth.key,
      "0",
      gavAddr,
      eth.secretToAddress(document.getElementById("to").value).pad(32) + document.getElementById("value").value.pad(32),
      "10000",
      eth.gasPrice
    );

    // eth.transact(eth.key, "0", gavCoinAddr, eth.secretToAddress(document.getElementById("to").value).pad(32) + document.getElementById("value").value.pad(32), "10000", eth.gasPrice)
  };
  // check = function () {
  //   document.getElementById("check").innerText = unbin(bin(document.getElementById("price").value * Math.pow(10,8)));
  // };
  // buy = function() {
  //   var data = bin(1).pad(32);
  //   data += bin(document.getElementById("amount").value * Math.pow(10,18)).pad(32);
  //   data += bin(document.getElementById("price").value * Math.pow(10,8)).pad(32);
  //   data += bin(1).pad(32);
  //   eth.transact(
  //     key.secret(eth.key()),
  //     0,
  //     etherExAddr,
  //     data,
  //     "100000",
  //     eth.gasPrice(),
  //     updateBalances
  //   );
  // };
  // sell = function() {
  //   var data = bin(2).pad(32);
  //   data += bin(document.getElementById("amount").value * Math.pow(10,18)).pad(32);
  //   data += bin(document.getElementById("price").value * Math.pow(10,8)).pad(32);
  //   data += bin(1).pad(32);
  //   eth.transact(
  //     key.secret(eth.key()),
  //     document.getElementById("amount").value * Math.pow(10,18),
  //     etherExAddr,
  //     data,
  //     "100000",
  //     eth.gasPrice(),
  //     updateBalances
  //   );
  // };
  getOrderbook = function() {
    var table = "<table><tr><th class='book'>Buy</th><th class='book'>Sell</th></tr>";
    var startkey = 100;
    var lastkey = eth.storageAt(tradesAddr, 10).dec();
    document.getElementById("last").innerText = lastkey;
    // var trades = u256.toValue(eth.storageAt(tradesAddr, u256.value(startkey)));
    // var prices = eth.keys;
    var check = 0;
    var booklength = lastkey / 5;
    for (var i = startkey; i < startkey + lastkey; i = i + 5) {
      // myaddr = u256.toValue(u256.fromAddress(key.address(indexes[i])));
      // price = indexes[i][1];
      var value = eth.storageAt(tradesAddr, i).dec();
      if (value) {
        var type = eth.storageAt(tradesAddr, i).dec();
        var price = eth.storageAt(tradesAddr, i+1).dec() / Math.pow(10, 8);
        var strprice = price + " ETH/BTC";
        var amount = eth.storageAt(tradesAddr, i+2).dec() / Math.pow(10, 18);
        var stramount = "<br />of " + eth.storageAt(tradesAddr, i+2).dec();
        document.getElementById("lastprice").innerText = price;
        var owner = "<br />by " + key.toAbridged(eth.storageAt(tradesAddr, i+3)).substr(2);
        if (price) {
          table += "<tr>\
                <td class='book'>" + ((type == 1) ? strprice + stramount + owner : '') + "</td>\
                <td class='book'>" + ((type == 2) ? strprice + stramount + owner : '') + "</td>\
            </tr>";
          document.getElementById("price").value = price;
        };
        if (amount) {
          document.getElementById("amount").value = amount;
        };
      };
    };
    table += "</table>";
    document.getElementById('book').innerHTML = table;
  };
  updateBalances = function() {
    // getOrderbook();
    document.getElementById("eth").innerText = eth.balanceAt(eth.coinbase).dec();
    document.getElementById("xeth").innerText = eth.balanceAt(xethAddr);
  	document.getElementById("gav").innerText = eth.storageAt(gavAddr, eth.coinbase).dec();
    document.getElementById("tot").innerText = eth.balanceAt(etherExAddr).dec();
  };
  eth.watch(xethAddr, eth.coinbase, updateBalances);
  updateBalances();
</script>
</head>
<body>
<h1>EtherEx</h1>
<h2><span id="eth">0 ETH</span></h2>
<h4><span id="xeth">0</span> in XETH</h4>
<h4><span id="gav">0</span> GAV</h4>
<h4>Exchange total: <span id="tot">0</span></h4>
<div>Price: <span id="lastprice">0</span></div>
<div>Last check: <span id="check">0</span></div>
<div id="book"></div>
<ul>
<li><label for="amount">Amount: </label><input id="amount" type="number" value=""/></li>
<li><label for="price">Price: </label><input id="price" type="number" value=""/></li>
<li><button onClick="buy()">Buy</button><button onClick="sell()">Sell</button><button onClick="check()">Check</button></li>
</ul>
<ul>
<li><label for="To">To: </label><input id="to" type="text" value=""/></li>
<li><label for="value">Value: </label><input id="value" type="number" value="1"/></li>
<li><button onClick="sendGav()">Send GAV</button><button onClick="updateBalances()">Refresh</button></li>
</ul>
<div>
  <div>Last ID count: <span id="last">0</span></div>
  Log: <div id="log"></div>
</div>
</body>
</html>
